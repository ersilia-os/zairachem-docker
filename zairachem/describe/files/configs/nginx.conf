worker_processes auto;

events {
    worker_connections 4096;
    multi_accept on;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;
    server_tokens   off;

    log_format main_json escape=json
      '{'
        '"time_local":"$time_local",'
        '"remote_addr":"$remote_addr",'
        '"request":"$request",'
        '"status":$status,'
        '"bytes_sent":$bytes_sent,'
        '"request_time":$request_time,'
        '"upstream_response_time":"$upstream_response_time",'
        '"upstream_addr":"$upstream_addr",'
        '"cache":"$upstream_cache_status"'
      '}';
    access_log /var/log/nginx/access.log main_json;

    gzip on;
    gzip_comp_level 5;
    gzip_min_length 1024;
    gzip_vary on;
    gzip_proxied any;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml
        application/xhtml+xml
        application/rss+xml
        font/woff
        font/woff2;

    proxy_cache_path /var/cache/nginx/api
        levels=1:2
        keys_zone=api_cache:20m
        max_size=1g
        inactive=10m
        use_temp_path=off;

    limit_req_zone $binary_remote_addr zone=perip:10m rate=10r/s;
    limit_conn_zone $binary_remote_addr zone=perip_conn:10m;

    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    add_header X-Content-Type-Options nosniff always;
    add_header X-Frame-Options SAMEORIGIN always;
    add_header Referrer-Policy strict-origin-when-cross-origin always;

    server {
        listen 80;
        server_name _;

        location = / {
            return 200 'Ersilia API gateway is up. Try one of the /<model_id>/ paths.\n';
            add_header Content-Type text/plain;
        }

    upstream eos2gw4_api {
        server eos2gw4_api:80;
        keepalive 64;
    }

    location /eos2gw4/ {
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_connect_timeout 30s;
        proxy_send_timeout 120s;
        proxy_read_timeout 300s;
        proxy_buffering on;
        proxy_buffers 32 16k;
        proxy_busy_buffers_size 64k;
        proxy_max_temp_file_size 0;
        proxy_next_upstream error timeout http_500 http_502 http_503 http_504;
        proxy_cache api_cache;
        proxy_cache_revalidate on;
        proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504 updating;
        proxy_cache_bypass $http_cache_control $http_pragma;
        proxy_no_cache $http_cache_control $http_pragma;
        proxy_cache_valid 200 301 302 10m;
        proxy_cache_valid 404 1m;
        add_header X-Cache-Status $upstream_cache_status always;
        limit_req zone=perip burst=20 nodelay;
        limit_conn perip_conn 40;
        proxy_pass http://eos2gw4_api/;
    }
    upstream eos4u6p_api {
        server eos4u6p_api:80;
        keepalive 64;
    }

    location /eos4u6p/ {
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_connect_timeout 30s;
        proxy_send_timeout 120s;
        proxy_read_timeout 300s;
        proxy_buffering on;
        proxy_buffers 32 16k;
        proxy_busy_buffers_size 64k;
        proxy_max_temp_file_size 0;
        proxy_next_upstream error timeout http_500 http_502 http_503 http_504;
        proxy_cache api_cache;
        proxy_cache_revalidate on;
        proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504 updating;
        proxy_cache_bypass $http_cache_control $http_pragma;
        proxy_no_cache $http_cache_control $http_pragma;
        proxy_cache_valid 200 301 302 10m;
        proxy_cache_valid 404 1m;
        add_header X-Cache-Status $upstream_cache_status always;
        limit_req zone=perip burst=20 nodelay;
        limit_conn perip_conn 40;
        proxy_pass http://eos4u6p_api/;
    }
    upstream eos5axz_api {
        server eos5axz_api:80;
        keepalive 64;
    }

    location /eos5axz/ {
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_connect_timeout 30s;
        proxy_send_timeout 120s;
        proxy_read_timeout 300s;
        proxy_buffering on;
        proxy_buffers 32 16k;
        proxy_busy_buffers_size 64k;
        proxy_max_temp_file_size 0;
        proxy_next_upstream error timeout http_500 http_502 http_503 http_504;
        proxy_cache api_cache;
        proxy_cache_revalidate on;
        proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504 updating;
        proxy_cache_bypass $http_cache_control $http_pragma;
        proxy_no_cache $http_cache_control $http_pragma;
        proxy_cache_valid 200 301 302 10m;
        proxy_cache_valid 404 1m;
        add_header X-Cache-Status $upstream_cache_status always;
        limit_req zone=perip burst=20 nodelay;
        limit_conn perip_conn 40;
        proxy_pass http://eos5axz_api/;
    }
    }
}
